#!/usr/bin/env bash

export TERMEX="1.0.0-rc.2"

if [ -t 1 ]
then
    ncolors=$(tput colors)
    
    if [ -n "$ncolors" ] && [ $ncolors -ge 8 ]
    then
        export bold="$(tput bold)"
        export underline="$(tput smul)"
        export standout="$(tput smso)"
        export normal="$(tput sgr0)"
        export black="$(tput setaf 0)"
        export red="$(tput setaf 1)"
        export green="$(tput setaf 2)"
        export yellow="$(tput setaf 3)"
        export blue="$(tput setaf 4)"
        export magenta="$(tput setaf 5)"
        export cyan="$(tput setaf 6)"
        export white="$(tput setaf 7)"
    fi
fi

function warn()
{
    echo "${yellow}WARN:$normal $@" >&2
}

function err()
{
    echo "${red}ERROR:$normal $@" >&2
}

function die()
{
    err "${@:2}"
    exit $1
}

function dbg()
{
    IFS="," read -ra debugs <<< "$1"
    for debug in "${debugs[@]}"
    do
        IFS="," read -ra channels <<< "$DEBUG"
        for channel in "${channels[@]}"
        do
            if [[ ${channel} == ${debug} ]]
            then
                echo -e "$blue$debug$normal\t${@:2}"
            fi
        done
    done
    
    unset debugs
    unset channels
}

function exit()
{
    local err=${1:-$?}
    dbg termex "Status code: $err"
    builtin exit $err
}

dbg termex "Termex initialized"

export SCRIPT="${1:-/dev/stdin}"
[ -f "$SCRIPT" ] || die -1 "No script to run!"
shift

dbg termex "Running script..."
. "$SCRIPT"
exit
